<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WormiBox - Dashboard Sensor</title>
    <link rel="icon" href="img/logo-WormiBox.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Poppins:wght@400;600;700;800&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ===========================================
           KONFIGURASI & KONSTANTA CSS
           =========================================== */
        :root {
            --primary-green: #0F5F4F;
            --title-green: #0B3F36;
            --accent-orange: #C1542E;
            --danger-red: #9B1212;
            --card-bg: #ffffff;
            --text-dark: #4B4B4B;
            --text-light: #666666;
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --grid-color: #E6E6E6;
            --inactive-arc: #DADADA;
            --humidity-start: #8B5328;
            --humidity-end: #D77A3A;
            --temp-start: #17A078;
            --temp-end: #D65A2A;
            --legend-humidity: #2F80ED;
            --legend-temp: #D75A4A;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Poppins', 'Nunito', system-ui, -apple-system, 'Segoe UI', sans-serif;
            background: var(--primary-green);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .dashboard-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* ===========================================
           TOP SUMMARY CARDS
           =========================================== */
        .summary-row {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            height: 110px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .summary-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .summary-card:hover {
            transform: translateY(-2px);
        }

        .summary-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .summary-icon img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .summary-icon.humidity {
            background: transparent;
        }

        .summary-icon.timestamp {
            background: transparent;
        }

        .summary-icon.temperature {
            background: transparent;
        }

        .summary-info h3 {
            font-size: 26px;
            color: #2d5a3d;
            font-weight: 700;
            margin: 0;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 1000;
            color: #333333;
            margin: 0;
            text-align: center;
        }

        /* ===========================================
           MAIN PANELS (GAUGE + CHART)
           =========================================== */
        .main-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin: 20px;
        }

        .sensor-panel {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px 24px 32px 24px;
            border: 2px solid var(--primary-green);
        }

        .panel-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--title-green);
            margin-bottom: 20px;
            text-align: center;
        }

        /* ===========================================
           GAUGE STYLING
           =========================================== */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .gauge-svg {
            width: 220px;
            height: 130px;
            margin-bottom: 8px;
        }

        .gauge-value {
            font-size: 44px;
            font-weight: 800;
            color: var(--accent-orange);
            margin-bottom: 8px;
            transition: color 1s ease-in-out;
            letter-spacing: -1px;
        }

        .gauge-status {
            font-size: 18px;
            font-weight: 700;
            font-style: italic;
            color: var(--danger-red);
            text-align: center;
            margin-bottom: 15px;
        }

        .status-normal {
            color: var(--title-green);
        }

        .status-warning {
            color: var(--danger-red);
        }

        /* ===========================================
           CHART STYLING
           =========================================== */
        .chart-section {
            margin-top: 15px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--title-green);
            margin-bottom: 12px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-legend {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
        }

        .legend-humidity {
            background-color: var(--legend-humidity);
        }

        .legend-temp {
            background-color: var(--legend-temp);
        }

        .chart-canvas {
            width: 100%;
            height: 180px;
            border-radius: 8px;
            background: #ffffff;
            border: 1px solid var(--grid-color);
        }

        /* ===========================================
           ERROR & LOADING STATES
           =========================================== */
        .error-message {
            background: #ffebee;
            color: var(--danger-red);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* ===========================================
           RESPONSIVE DESIGN
           =========================================== */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .dashboard-header h1 {
                font-size: 2rem;
            }

            .header-top {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .summary-row {
                flex-direction: column;
            }

            .main-panels {
                grid-template-columns: 1fr;
                margin: 15px;
            }

            .sensor-panel {
                padding: 20px;
            }

            .gauge-svg {
                width: 200px;
                height: 120px;
            }

            .gauge-value {
                font-size: 36px;
            }

            .panel-title {
                font-size: 22px;
            }

            .chart-canvas {
                height: 150px;
            }
        }

        /* ===========================================
           ANIMATIONS
           =========================================== */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-top">
                <div class="user-info">
                    <span id="user-email">Loading...</span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <h1>WormiBox Sensor Dashboard</h1>
            <p>Monitoring Kelembaban & Suhu Secara Real-time</p>
        </div>

        <!-- Error Message Container -->
        <div id="error-container"></div>

        <!-- Top Summary Cards -->
        <div class="summary-row">
            <div class="summary-card fade-in">
                <div class="summary-header">
                    <div class="summary-icon humidity">
                        <img src="img/dashboard/humidity.png" alt="Humidity Icon">
                    </div>
                    <div class="summary-info">
                        <h3>Humidity</h3>
                    </div>
                </div>
                <div class="summary-value" id="summary-humidity">54%</div>
            </div>

            <div class="summary-card fade-in">
                <div class="summary-header">
                    <div class="summary-icon timestamp">
                        <img src="img/dashboard/timestamp.png" alt="Timestamp Icon">
                    </div>
                    <div class="summary-info">
                        <h3>Timestamp</h3>
                    </div>
                </div>
                <div class="summary-value" id="summary-timestamp">98</div>
            </div>

            <div class="summary-card fade-in">
                <div class="summary-header">
                    <div class="summary-icon temperature">
                        <img src="img/dashboard/temperature.png" alt="Temperature Icon">
                    </div>
                    <div class="summary-info">
                        <h3>Temperature</h3>
                    </div>
                </div>
                <div class="summary-value" id="summary-temperature">36,9°C</div>
            </div>
        </div>

        <!-- Main Sensor Panels -->
        <div class="main-panels">
            <!-- Humidity Panel -->
            <div class="sensor-panel fade-in">
                <h2 class="panel-title">Gauge Humidity</h2>
                
                <div class="gauge-container">
                    <svg class="gauge-svg" id="humidity-gauge">
                        <!-- SVG gauge akan dirender oleh JavaScript -->
                    </svg>
                    <div class="gauge-value" id="humidity-value" aria-live="polite">---%</div>
                    <div class="gauge-status" id="humidity-status">Memuat...</div>
                </div>

                <div class="chart-section">
                    <h3 class="chart-title">
                        <span class="chart-legend legend-humidity"></span>
                        Humidity (%) - Per 7 Day
                    </h3>
                    <canvas class="chart-canvas" id="humidity-chart"></canvas>
                </div>
            </div>

            <!-- Temperature Panel -->
            <div class="sensor-panel fade-in">
                <h2 class="panel-title">Gauge Temperature</h2>
                
                <div class="gauge-container">
                    <svg class="gauge-svg" id="temperature-gauge">
                        <!-- SVG gauge akan dirender oleh JavaScript -->
                    </svg>
                    <div class="gauge-value" id="temperature-value" aria-live="polite">---°C</div>
                    <div class="gauge-status" id="temperature-status">Memuat...</div>
                </div>

                <div class="chart-section">
                    <h3 class="chart-title">
                        <span class="chart-legend legend-temp"></span>
                        Temperature (°C) - Per 7 Day
                    </h3>
                    <canvas class="chart-canvas" id="temperature-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAQJxouh3wBFN1VA7TZ8JyVCPUbHaj7T34",
            authDomain: "wormiboxdb.firebaseapp.com",
            databaseURL: "https://wormiboxdb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wormiboxdb",
            storageBucket: "wormiboxdb.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Global variables for Firebase
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.currentUser = null;
        
        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                console.log('User logged in:', user.email);
                // User is signed in, initialize dashboard
                if (typeof initializeDashboard === 'function') {
                    initializeDashboard();
                }
            } else {
                // User is signed out, redirect to login
                console.log('No user logged in, redirecting...');
                window.location.href = 'index.html';
            }
        });

        // Logout function
        window.logout = function() {
            signOut(auth).then(() => {
                console.log('User signed out');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Sign out error:', error);
            });
        };
    </script>

    <script>
        /* ===========================================
           KONFIGURASI & KONSTANTA
           =========================================== */
        
        // Interval polling data (dalam milisecond)
        const POLL_INTERVAL_MS = 5000; // 5 detik
        
        // Range untuk gauge
        const HUMIDITY_RANGE = {
            MIN: 10,          // Minimum 10%
            MAX: 90           // Maximum 90%
        };
        
        const TEMPERATURE_RANGE = {
            MIN: 35.0,        // Minimum 35.0°C
            MAX: 39.0         // Maximum 39.0°C
        };
        
        // Threshold untuk status sensor
        const HUMIDITY_THRESHOLDS = {
            TOO_DRY: 30,      // < 30% = terlalu kering
            TOO_HUMID: 65     // > 65% = terlalu lembab
        };
        
        const TEMPERATURE_THRESHOLDS = {
            TOO_HOT: 37.5     // > 37.5°C = terlalu panas
        };

        /* ===========================================
           GLOBAL VARIABLES
           =========================================== */
        
        let currentData = {
            humidity: 0,
            temperature: 0,
            timestamp: 0
        };

        // Data history untuk chart (7 hari terakhir)
        let humidityHistory = [];
        let temperatureHistory = [];
        
        let pollInterval;
        let isFirstLoad = true;

        /* ===========================================
           UTILITY FUNCTIONS
           =========================================== */
        
        function formatNumber(num, decimals = 1) {
            return parseFloat(num).toFixed(decimals).replace('.', ',');
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        function addLoadingState() {
            document.querySelector('.dashboard-container').classList.add('loading');
        }

        function removeLoadingState() {
            document.querySelector('.dashboard-container').classList.remove('loading');
        }

        /* ===========================================
           DATA FETCHING & PARSING
           =========================================== */
        
        async function fetchSensorData() {
            try {
                if (!window.currentUser) {
                    throw new Error('No authenticated user');
                }

                // Get user-specific data path using sanitized email
                const userEmail = window.currentUser.email;
                const sanitizedEmail = userEmail.replace(/[.#$[\]]/g, '_');
                
                // Import Firebase functions
                const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js");
                
                // Get user data from Firebase Realtime Database
                const userDataRef = ref(window.firebaseDatabase, `users/${sanitizedEmail}`);
                const snapshot = await get(userDataRef);
                
                if (!snapshot.exists()) {
                    throw new Error('No data found for this user');
                }

                const data = snapshot.val();
                
                // Parse data dari Firebase
                const parsedData = {
                    humidity: parseFloat(data.kelembapan || data.humidity || '0'),
                    temperature: parseFloat(data.suhu || data.temperature || '0'),
                    timestamp: data.timestamp || new Date().toLocaleString('id-ID')
                };

                currentData = parsedData;
                updateDashboard();
                
                if (isFirstLoad) {
                    removeLoadingState();
                    isFirstLoad = false;
                }

                console.log('Data berhasil dimuat untuk user:', userEmail, parsedData);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showError(`Gagal memuat data: ${error.message}`);
                
                // Fallback data jika tidak ada data di database
                if (isFirstLoad) {
                    currentData = {
                        humidity: 45,
                        temperature: 36.5,
                        timestamp: new Date().toLocaleString('id-ID')
                    };
                    updateDashboard();
                    removeLoadingState();
                    isFirstLoad = false;
                    showError('Menggunakan data demo - data pengguna belum tersedia');
                }
            }
        }

        /* ===========================================
           DASHBOARD UPDATE FUNCTIONS
           =========================================== */
        
        function updateDashboard() {
            updateSummaryCards();
            updateGauges();
            updateCharts();
        }

        function updateSummaryCards() {
            document.getElementById('summary-humidity').textContent = `${formatNumber(currentData.humidity)}%`;
            document.getElementById('summary-temperature').textContent = `${formatNumber(currentData.temperature)}°C`;
            document.getElementById('summary-timestamp').textContent = currentData.timestamp;
        }

        function updateGauges() {
            // Update Humidity Gauge
            updateHumidityGauge(currentData.humidity);
            document.getElementById('humidity-value').textContent = `${Math.round(currentData.humidity)}%`;
            document.getElementById('humidity-value').setAttribute('aria-label', `Humidity: ${Math.round(currentData.humidity)} percent`);
            document.getElementById('humidity-status').textContent = getHumidityStatus(currentData.humidity);
            document.getElementById('humidity-status').className = `gauge-status ${getHumidityStatusClass(currentData.humidity)}`;

            // Update Temperature Gauge
            updateTemperatureGauge(currentData.temperature);
            document.getElementById('temperature-value').textContent = `${formatNumber(currentData.temperature)}°C`;
            document.getElementById('temperature-value').setAttribute('aria-label', `Temperature: ${formatNumber(currentData.temperature)} degree celsius`);
            document.getElementById('temperature-status').textContent = getTemperatureStatus(currentData.temperature);
            document.getElementById('temperature-status').className = `gauge-status ${getTemperatureStatusClass(currentData.temperature)}`;
        }

        /* ===========================================
           STATUS LOGIC
           =========================================== */
        
        function getHumidityStatus(humidity) {
            if (humidity < HUMIDITY_THRESHOLDS.TOO_DRY) return 'Too dry';
            if (humidity > HUMIDITY_THRESHOLDS.TOO_HUMID) return 'Too humid';
            return 'Normal';
        }

        function getHumidityStatusClass(humidity) {
            return (humidity < HUMIDITY_THRESHOLDS.TOO_DRY || humidity > HUMIDITY_THRESHOLDS.TOO_HUMID) 
                ? 'status-warning' : 'status-normal';
        }

        function getTemperatureStatus(temperature) {
            if (temperature > TEMPERATURE_THRESHOLDS.TOO_HOT) return 'Too hot';
            return 'Normal';
        }

        function getTemperatureStatusClass(temperature) {
            return temperature > TEMPERATURE_THRESHOLDS.TOO_HOT ? 'status-warning' : 'status-normal';
        }

        /* ===========================================
           SVG GAUGE RENDERING
           =========================================== */
        
        function getColorAtPercentage(percentage, colors) {
            // Interpolasi langsung antara start dan end
            const ratio = percentage / 100;
            return interpolateColor(colors.start, colors.end, ratio);
        }
        
        function interpolateColor(color1, color2, ratio) {
            const hex1 = color1.replace('#', '');
            const hex2 = color2.replace('#', '');
            
            const r1 = parseInt(hex1.substr(0, 2), 16);
            const g1 = parseInt(hex1.substr(2, 2), 16);
            const b1 = parseInt(hex1.substr(4, 2), 16);
            
            const r2 = parseInt(hex2.substr(0, 2), 16);
            const g2 = parseInt(hex2.substr(2, 2), 16);
            const b2 = parseInt(hex2.substr(4, 2), 16);
            
            const r = Math.round(r1 + (r2 - r1) * ratio);
            const g = Math.round(g1 + (g2 - g1) * ratio);
            const b = Math.round(b1 + (b2 - b1) * ratio);
            
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        
        function createGaugeSVG(containerId, value, minValue, maxValue, colors) {
            const container = document.getElementById(containerId);
            
            // Hitung persentase berdasarkan range yang baru
            const normalizedValue = Math.max(minValue, Math.min(maxValue, value));
            const percentage = ((normalizedValue - minValue) / (maxValue - minValue)) * 100;
            const angle = (percentage / 100) * 180; // Semi-circle (180 degrees)
            
            // Dapatkan warna untuk nilai saat ini
            const currentColor = getColorAtPercentage(percentage, colors);
            
            container.innerHTML = `
                <defs>
                    <linearGradient id="${containerId}-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:${colors.start};stop-opacity:1" />
                        <stop offset="100%" style="stop-color:${colors.end};stop-opacity:1" />
                    </linearGradient>
                </defs>
                
                <!-- Background Arc (inactive) -->
                <path d="M 30 110 A 80 80 0 0 1 190 110" 
                      stroke="#DADADA" 
                      stroke-width="35" 
                      fill="none"/>
                
                <!-- Active Arc with Gradient -->
                <path id="${containerId}-arc"
                      d="M 30 110 A 80 80 0 0 1 190 110" 
                      stroke="url(#${containerId}-gradient)" 
                      stroke-width="35" 
                      fill="none"
                      stroke-dasharray="${Math.PI * 80} ${Math.PI * 80}"
                      stroke-dashoffset="${Math.PI * 80 - (Math.PI * 80 * percentage / 100)}"
                      stroke-linecap="round"
                      style="transition: stroke-dashoffset 1s ease-in-out;"/>
                
                <!-- Triangular Pointer -->
                <g id="${containerId}-pointer" transform="rotate(${angle - 90} 110 110)" 
                   style="transition: transform 1s ease-in-out;">
                    <polygon points="110,50 106,60 114,60" 
                             fill="${currentColor}" 
                             stroke="${currentColor}" 
                             stroke-width="1"/>
                </g>
            `;
            
            // Update warna nilai angka sesuai dengan warna gauge
            const valueElement = document.getElementById(containerId.replace('-gauge', '-value'));
            if (valueElement) {
                valueElement.style.color = '#C1542E';
            }
        }

        function updateHumidityGauge(value) {
            const colors = {
                start: '#8B5328',   // Brown
                end: '#D77A3A'      // Orange
            };
            createGaugeSVG('humidity-gauge', value, HUMIDITY_RANGE.MIN, HUMIDITY_RANGE.MAX, colors);
        }

        function updateTemperatureGauge(value) {
            const colors = {
                start: '#17A078',   // Green
                end: '#D65A2A'      // Orange-Red
            };
            createGaugeSVG('temperature-gauge', value, TEMPERATURE_RANGE.MIN, TEMPERATURE_RANGE.MAX, colors);
        }

        /* ===========================================
           CHART RENDERING (Canvas)
           =========================================== */
        
        function updateCharts() {
            // Update history arrays
            updateHistoryData();
            
            // Draw charts
            drawChart('humidity-chart', humidityHistory, '%', '#2F80ED');
            drawChart('temperature-chart', temperatureHistory, '°C', '#D75A4A');
        }

        function updateHistoryData() {
            // Add current values to history
            humidityHistory.push(currentData.humidity);
            temperatureHistory.push(currentData.temperature);
            
            // Keep only last 7 days
            if (humidityHistory.length > 7) {
                humidityHistory.shift();
            }
            if (temperatureHistory.length > 7) {
                temperatureHistory.shift();
            }
            
            // Fill with dummy data if less than 7 points (for demo purposes)
            while (humidityHistory.length < 7) {
                const baseValue = currentData.humidity || 50; // Default fallback
                const randomVariation = (Math.random() - 0.5) * 20; // ±10 variation
                const dummyValue = Math.max(HUMIDITY_RANGE.MIN, Math.min(HUMIDITY_RANGE.MAX, baseValue + randomVariation));
                humidityHistory.unshift(dummyValue);
            }
            
            while (temperatureHistory.length < 7) {
                const baseValue = currentData.temperature || 37; // Default fallback
                const randomVariation = (Math.random() - 0.5) * 2; // ±1 variation
                const dummyValue = Math.max(TEMPERATURE_RANGE.MIN, Math.min(TEMPERATURE_RANGE.MAX, baseValue + randomVariation));
                temperatureHistory.unshift(dummyValue);
            }
        }

        function drawChart(canvasId, data, unit, color) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth * 2; // Higher resolution
            canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2); // Scale for crisp lines
            
            const width = canvas.width / 2;
            const height = canvas.height / 2;
            const padding = 50;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            if (data.length === 0) return;
            
            // Calculate min/max for scaling - match design
            const minValue = Math.min(...data) * 0.98;
            const maxValue = Math.max(...data) * 1.02;
            const valueRange = maxValue - minValue || 1;
            
            // Draw chart background (white)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            // Draw horizontal grid lines
            ctx.strokeStyle = '#E6E6E6';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Draw area fill dengan warna sesuai design
            let areaColor;
            if (unit === '%') {
                areaColor = 'rgba(47, 128, 237, 0.1)'; // Light blue untuk humidity
            } else {
                areaColor = 'rgba(215, 90, 74, 0.1)'; // Light red untuk temperature  
            }
            
            ctx.fillStyle = areaColor;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            
            for (let i = 0; i < data.length; i++) {
                const x = padding + (chartWidth / (data.length - 1)) * i;
                const y = height - padding - ((data[i] - minValue) / valueRange) * chartHeight;
                if (i === 0) {
                    ctx.lineTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.lineTo(width - padding, height - padding);
            ctx.closePath();
            ctx.fill();
            
            // Draw main line (simple, not curved)
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            for (let i = 0; i < data.length; i++) {
                const x = padding + (chartWidth / (data.length - 1)) * i;
                const y = height - padding - ((data[i] - minValue) / valueRange) * chartHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Draw data points (smaller)
            ctx.fillStyle = color;
            for (let i = 0; i < data.length; i++) {
                const x = padding + (chartWidth / (data.length - 1)) * i;
                const y = height - padding - ((data[i] - minValue) / valueRange) * chartHeight;
                
                ctx.beginPath();
                ctx.arc(x, y, 2.5, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // Draw Y-axis labels (left side)
            ctx.fillStyle = '#4B4B4B';
            ctx.font = '12px Inter, Poppins, Nunito, system-ui';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                const value = maxValue - (valueRange / 5) * i;
                let formattedValue;
                
                if (unit === '°C') {
                    formattedValue = value.toFixed(1).replace('.', ',') + unit;
                } else {
                    formattedValue = Math.round(value) + unit;
                }
                
                ctx.fillText(formattedValue, padding - 8, y);
            }
            
            // Draw X-axis labels (bottom)
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            
            // Generate date labels (last 7 days)
            const today = new Date();
            for (let i = 0; i < data.length; i++) {
                const x = padding + (chartWidth / (data.length - 1)) * i;
                const date = new Date(today);
                date.setDate(date.getDate() - (data.length - 1 - i));
                const dayMonth = `${date.getDate()} ${['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'][date.getMonth()]}`;
                ctx.fillText(dayMonth, x, height - padding + 8);
            }
            
            // Reset text properties
            ctx.textBaseline = 'alphabetic';
        }

        /* ===========================================
           INITIALIZATION & POLLING
           =========================================== */
        
        function initializeDashboard() {
            console.log('Initializing WormiBox Dashboard...');
            
            // Update user email display
            if (window.currentUser) {
                document.getElementById('user-email').textContent = `Logged in as: ${window.currentUser.email}`;
            }
            
            addLoadingState();
            
            // Initial data fetch
            fetchSensorData();
            
            // Set up polling interval
            pollInterval = setInterval(fetchSensorData, POLL_INTERVAL_MS);
            
            console.log(`Polling started with ${POLL_INTERVAL_MS}ms interval`);
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        });

        // Setup sample data for demo users (only run once)
        async function setupSampleData() {
            try {
                const { ref, set } = await import("https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js");
                
                // Sample data for wormibox@gmail.com
                const wormiboxEmail = 'wormibox_gmail_com';
                const wormiboxRef = ref(window.firebaseDatabase, `users/${wormiboxEmail}`);
                
                await set(wormiboxRef, {
                    email: 'wormibox@gmail.com',
                    suhu: 36.8,
                    kelembapan: 52,
                    timestamp: new Date().toLocaleString('id-ID')
                });
                
                // Sample data for another user
                const testEmail = 'test_user_gmail_com';
                const testRef = ref(window.firebaseDatabase, `users/${testEmail}`);
                
                await set(testRef, {
                    email: 'test.user@gmail.com',
                    suhu: 37.2,
                    kelembapan: 48,
                    timestamp: new Date().toLocaleString('id-ID')
                });
                
                console.log('Sample data setup complete');
            } catch (error) {
                console.error('Error setting up sample data:', error);
            }
        }

        // Uncomment the line below to setup sample data (run once only)
        // setupSampleData();

        // Start dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Dashboard will be initialized by Firebase auth state change
        });
        
        /* ===========================================
           ADAPTIVE HISTORY ENDPOINT (PLACEHOLDER)
           =========================================== */
        
        // NOTE: Jika Firebase menyediakan endpoint history terpisah,
        // ganti logik di updateHistoryData() dengan:
        /*
        async function fetchHistoryData() {
            try {
                const response = await fetch('https://your-firebase-url/history.json');
                const historyData = await response.json();
                
                if (historyData && historyData.humidity && historyData.temperature) {
                    humidityHistory = historyData.humidity.slice(-7);
                    temperatureHistory = historyData.temperature.slice(-7);
                }
            } catch (error) {
                console.warn('History data not available, using current values with variation');
                // Fallback ke logik current dengan variasi acak
            }
        }
        */

    </script>
</body>
</html>